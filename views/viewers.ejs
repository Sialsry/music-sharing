<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬ì´ê¹€&ë®¤ì§ìŠ¤ - ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="/public/css/live.css">
  <style>
    video::-webkit-media-controls-play-button,
    video::-webkit-media-controls-pause-button {
      display: none;
    }

    .featured-video {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #main-stream {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <%- include('common/header') %>
  <div class="container">
    <h1 class="page-title">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</h1>
    <div style="display: flex; margin-left: 80px;">
      <div>
        <div class="featured-stream">
          <div class="featured-stream-content">
            <div class="featured-video">
              <video id="main-stream" autoplay muted playsinline></video>
            </div>
            <div class="stream-info">
              <span class="live-indicator">LIVE</span>
              <h2 class="stream-title" id="stream-title">ë¼ì´ë¸Œ ë°©ì†¡</h2>
              <p class="stream-artist" id="stream-artist">ë°©ì†¡ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
          </div>
        </div>
      </div>

      <div class="live-interaction">
        <div class="chat-section">
          <div class="chat-header">ì‹¤ì‹œê°„ ì±„íŒ…</div>
          <div class="chat-messages" id="chat-box"></div>
          <div class="chat-input">
            <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button>ì „ì†¡</button>
          </div>
        </div>
        <div class="online-users">
          <div class="online-header">ì ‘ì†ì</div>
          <div class="user-list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div>Â© 2025 êµ¬ì´ê¹€&ë®¤ì§ìŠ¤. All rights reserved.</div>
      <div class="footer-links">
        <a href="/about">íšŒì‚¬ ì†Œê°œ</a>
        <a href="/terms">ì´ìš©ì•½ê´€</a>
        <a href="/privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        <a href="/contact">ê³ ê°ì§€ì›</a>
      </div>
    </div>
  </footer>

  <script>
    const videoElement = document.getElementById('main-stream');
    const socket = io();

    // ğŸ§‘ ì—­í•  ì§€ì • ë° ë°© ì…ì¥
    socket.emit("join", "viewer");

    // ğŸ¥ ì˜ìƒ ìˆ˜ì‹  ì²˜ë¦¬
    const mediaSource = new MediaSource();
    videoElement.src = URL.createObjectURL(mediaSource);

    let sourceBuffer;
    mediaSource.addEventListener("sourceopen", () => {
      sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp9"');

      socket.on("videoChunk", (chunk) => {
        console.log("ğŸ¥ ì˜ìƒ ë„ì°©í•¨!", chunk);
        if (sourceBuffer.updating || !chunk) return;

        try {
          const typedArray = new Uint8Array(chunk);
          sourceBuffer.appendBuffer(typedArray);
        } catch (err) {
          console.error("ì˜ìƒ ì¶”ê°€ ì‹¤íŒ¨:", err);
        }
      });

      // ë…¹í™” ì¢…ë£Œ ì‹œ ì•Œë¦¼
      socket.on("endRecording", () => {
        console.log("ğŸ¬ ë°©ì†¡ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      });
    });

    // ğŸ’¬ ì±„íŒ… ê¸°ëŠ¥
    const chatInput = document.querySelector('.chat-input input');
    const chatButton = document.querySelector('.chat-input button');
    const chatBox = document.getElementById('chat-box');

    function sendMessage() {
      const message = chatInput.value.trim();
      if (message !== '') {
        socket.emit('sendMessage', message);
        chatInput.value = '';
      }
    }

    chatButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    socket.on('receiveMessage', (message) => {
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      messageElement.innerHTML = `
        <div class="user-name">ë‚˜</div>
        <div class="message-text">${message}</div>
      `;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // ğŸ‘¥ ì ‘ì†ì ëª©ë¡ í‘œì‹œ
    socket.on('updateUserList', (userList) => {
      const userListDiv = document.querySelector('.user-list');
      userListDiv.innerHTML = '';
      userList.forEach(user => {
        const userItem = document.createElement('div');
        userItem.textContent = `ğŸ‘¤ì ‘ì†.`;
        userItem.className = 'user-item';
        userListDiv.appendChild(userItem);
      });
    });
  </script>
</body>
</html>
