<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬ì´ê¹€&ë®¤ì§ìŠ¤ - ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="/public/css/live.css">
  <style>
    .featured-video {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #main-stream {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <%- include('common/header') %>
  <div class="container">
    <h1 class="page-title">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</h1>
    <div style="display: flex; margin-left: 80px;">
      <div>
        <div class="featured-stream">
          <div class="featured-stream-content">
            <div class="featured-video">
              <video id="main-stream" autoplay playsinline></video>
              <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 6px; border-radius: 8px;">
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
              </div>
            </div>
            <div class="stream-info">
              <span class="live-indicator">LIVE</span>
              <h2 class="stream-title" id="stream-title">ë¼ì´ë¸Œ ë°©ì†¡</h2>
              <p class="stream-artist" id="stream-artist">ë°©ì†¡ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
          </div>
        </div>
      </div>

      <div class="live-interaction">
        <div class="chat-section">
          <div class="chat-header">ì‹¤ì‹œê°„ ì±„íŒ…</div>
          <div class="chat-messages" id="chat-box"></div>
          <div class="chat-input">
            <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button>ì „ì†¡</button>
          </div>
        </div>
        <div class="online-users">
          <div class="online-header">ì ‘ì†ì</div>
          <div class="user-list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div>Â© 2025 êµ¬ì´ê¹€&ë®¤ì§ìŠ¤. All rights reserved.</div>
      <div class="footer-links">
        <a href="/about">íšŒì‚¬ ì†Œê°œ</a>
        <a href="/terms">ì´ìš©ì•½ê´€</a>
        <a href="/privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        <a href="/contact">ê³ ê°ì§€ì›</a>
      </div>
    </div>
  </footer>
  <script>
    const videoElement = document.getElementById('main-stream');
    const socket = io();
  
    // ì˜¤ë””ì˜¤ ê´€ë ¨ ì„¤ì •
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let gainNode;
    let audioSource;
  
    // MediaSource ì´ˆê¸°í™”
    const mediaSource = new MediaSource();
    videoElement.src = URL.createObjectURL(mediaSource);
  
    let sourceBuffer;
    let chunkQueue = [];
  
    mediaSource.addEventListener('sourceopen', () => {
      if (MediaSource.isTypeSupported('video/webm; codecs="vp9,opus"')) {
        sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp9,opus"');
  
        sourceBuffer.addEventListener('updateend', () => {
          if (chunkQueue.length > 0 && !sourceBuffer.updating) {
            const nextChunk = chunkQueue.shift();
            try {
              sourceBuffer.appendBuffer(nextChunk);
            } catch (e) {
              console.error('appendBuffer ì—ëŸ¬ (íì—ì„œ):', e);
            }
          }
        });
  
        socket.on('videoChunk', (chunk) => {
          const reader = new FileReader();
          reader.onload = function () {
            const buffer = new Uint8Array(this.result);
            if (sourceBuffer.updating || chunkQueue.length > 0) {
              chunkQueue.push(buffer);
            } else {
              try {
                sourceBuffer.appendBuffer(buffer);
              } catch (e) {
                console.error('appendBuffer ì—ëŸ¬:', e);
                chunkQueue.push(buffer); // ì‹¤íŒ¨ ì‹œ íì— ë‹¤ì‹œ ì €ì¥
              }
            }
          };
          if (chunk instanceof Blob) {
            reader.readAsArrayBuffer(chunk);
          } else {
            reader.readAsArrayBuffer(new Blob([chunk]));
          }
        });
  
        // ì˜ìƒ ì¬ìƒ ì‹œ ì˜¤ë””ì˜¤ ì„¤ì •
        videoElement.addEventListener('play', () => {
          if (!gainNode) {
            const stream = videoElement.captureStream();
            const audioTracks = stream.getAudioTracks();
            if (audioTracks.length > 0) {
              const audioStream = new MediaStream([audioTracks[0]]);
              audioSource = audioContext.createMediaStreamSource(audioStream);
              gainNode = audioContext.createGain();
              audioSource.connect(gainNode).connect(audioContext.destination);
            }
          }
        });
  
        // ë³¼ë¥¨ ìŠ¬ë¼ì´ë”
        const volumeSlider = document.getElementById('volumeSlider');
        volumeSlider.addEventListener('input', () => {
          if (gainNode) {
            gainNode.gain.value = parseFloat(volumeSlider.value);
          }
        });
  
        socket.on('endRecording', () => {
          console.log('ğŸ¬ ë°©ì†¡ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          if (mediaSource.readyState === 'open') {
            try {
              mediaSource.endOfStream();
            } catch (e) {
              console.warn('endOfStream ì‹¤íŒ¨:', e);
            }
          }
        });
  
      } else {
        console.error('ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¯¸ë””ì–´ í˜•ì‹ì…ë‹ˆë‹¤.');
      }
    });
  
    // ì±„íŒ… ê¸°ëŠ¥
    const chatInput = document.querySelector('.chat-input input');
    const chatButton = document.querySelector('.chat-input button');
    const chatBox = document.getElementById('chat-box');
  
    function sendMessage() {
      const message = chatInput.value.trim();
      if (message !== '') {
        socket.emit('sendMessage', message);
        chatInput.value = '';
      }
    }
  
    chatButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  
    socket.on('receiveMessage', (message) => {
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      messageElement.innerHTML = `
        <div class="user-name">ë‚˜</div>
        <div class="message-text">${message}</div>
      `;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  
    // ì ‘ì†ì ëª©ë¡
    socket.on('updateUserList', (userList) => {
      const userListDiv = document.querySelector('.user-list');
      userListDiv.innerHTML = '';
      userList.forEach((user) => {
        const userItem = document.createElement('div');
        userItem.textContent = `ğŸ‘¤ ì ‘ì†`;
        userItem.className = 'user-item';
        userListDiv.appendChild(userItem);
      });
    });
  </script>
</body>
</html>
