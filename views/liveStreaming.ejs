<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬ì´ê¹€&ë®¤ì§ìŠ¤ - ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="/public/css/live.css">
  <style>
    video::-webkit-media-controls-play-button,
    video::-webkit-media-controls-pause-button {
      display: none;
    }
    video::-moz-media-controls {
      display: none;
    }
  .featured-video {
  position: relative;
  width: 100%;
  height: 100%;
}

#hostCanvas, #main-stream {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
  </style>
</head>
<body>
  <%- include('common/header') %>
  <div class="container">
    <h1 class="page-title">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</h1>
    <div style="display: flex; margin-left: 80px;">
      <div>
        <div class="featured-stream">
          <div class="featured-stream-content">
            <div class="featured-video">
              <canvas id="hostCanvas"></canvas>
              <video id="main-stream" controls style="width:100%; height:100%; object-fit:cover;"></video>
            </div>
            <div class="stream-info">
              <span class="live-indicator">LIVE</span>
              <h2 class="stream-title" id="stream-title">ê³¡ ì œëª© ë¡œë”© ì¤‘...</h2>
              <p class="stream-artist" id="stream-artist">ì•„í‹°ìŠ¤íŠ¸ ì •ë³´</p>
              <button id="startRecording">ë…¹í™” ì‹œì‘</button>
              <button id="stopRecording" style="display: none">ë…¹í™” ì¤‘ì§€</button>
            </div>
          </div>
        </div>

        <div class="media-controls">
          <div class="playback-controls">
            <button id="prevBtn">â®</button>
            <button id="rewindBtn">âª</button>
            <button class="play-button">â¸</button>
            <button id="fastForwardBtn">â©</button>
            <button id="nextBtn">â­</button>
          </div>
          <div class="volume-control">
            <span>ğŸ”Š</span>
            <input type="range" min="0" max="100" value="50" class="volume-slider">
          </div>
        </div>
      </div>

      <div class="live-interaction">
        <div class="chat-section">
          <div class="chat-header">ì‹¤ì‹œê°„ ì±„íŒ…</div>
          <div class="chat-messages" id="chat-box"></div>
          <div class="chat-input">
            <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button>ì „ì†¡</button>
          </div>
        </div>
        <div class="online-users">
          <div class="online-header">ì ‘ì†ì</div>
          <div class="user-list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div>Â© 2025 êµ¬ì´ê¹€&ë®¤ì§ìŠ¤. All rights reserved.</div>
      <div class="footer-links">
        <a href="/about">íšŒì‚¬ ì†Œê°œ</a>
        <a href="/terms">ì´ìš©ì•½ê´€</a>
        <a href="/privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        <a href="/contact">ê³ ê°ì§€ì›</a>
      </div>
    </div>
  </footer>
  <script>
    const playButton = document.querySelector('.play-button');
    const videoElement = document.getElementById('main-stream');
    const titleElement = document.getElementById('stream-title');
    const artistElement = document.getElementById('stream-artist');
    const startRecordingBtn = document.getElementById('startRecording');
    const stopRecordingBtn = document.getElementById('stopRecording');
    const volumeSlider = document.querySelector('.volume-slider');
    const hostCanvas = document.getElementById("hostCanvas");
    const hostCtx = hostCanvas.getContext("2d");
    
    ////////////////////////////////
    let mediaRecorder;
    let recordedChunks = [];  
    ///////////////////////////////
    let userImage = new Image();
    let imageLoaded = false;
    userImage.onload = function() {
      imageLoaded = true;
    };
    let isPlaying = false;
    let musicdata = [];
    let currentIndex = 0;
    let role = null;
    let socket = io();
    const chatBubbles = [];
    
    function initializeRole(selectedRole) {
        role = selectedRole;
        //ì—°ê²° ìš”ì²­
        socket = io("http://localhost:3000");
        socket.emit("join", role);
      }

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const playlistName = urlParams.get('playlistName');
      const musicId = urlParams.get('musicId');
      if (!playlistName) {
        alert("Missing playlistName in URL");
        return;
      }
      try {
        const res = await axios.get(`/live/api/musiclist/${encodeURIComponent(playlistName)}`);
        const allMusic = res.data;

        const filteredMusic = musicId? allMusic.filter(music => music.musicid == musicId): allMusic;

        musicdata = filteredMusic;

        if (!musicdata.length) {
          alert("ì¬ìƒí•  ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const playNext = () => {
          if (currentIndex >= musicdata.length) {
            console.log("ëª¨ë“  íŠ¸ë™ ì¬ìƒ ì™„ë£Œ");
            return;
          }
          let image = new Image();

          const music = musicdata[currentIndex];
          videoElement.src = `/public/musics/${music.musicResource}`;
          imageLoaded = false; 
          userImage.src = `/public/images/${music.songImg}`; 
          titleElement.textContent = music.songName || 'ì œëª© ì—†ìŒ';
          artistElement.textContent = `ì•„í‹°ìŠ¤íŠ¸: ${music.artist || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;

          videoElement.play().catch(error => {
            console.warn("ìë™ ì¬ìƒ ì‹¤íŒ¨: ì‚¬ìš©ì ì•¡ì…˜ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ.", error);
          });
          currentIndex++;
        };

        videoElement.addEventListener('ended', playNext);
        drawHostCanvas(); 
        playNext();

      } catch (error) {
        console.error("ìŒì•… ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
      }
    });

    function drawHostCanvas() {
    
    hostCtx.clearRect(0, 0, hostCanvas.width, hostCanvas.height);
    if (imageLoaded) {
      hostCtx.drawImage(userImage, 0, 0, hostCanvas.width, hostCanvas.height);
    } else {
      hostCtx.fillStyle = "black";
      hostCtx.fillRect(0, 0, hostCanvas.width, hostCanvas.height);
    }
    for (let i = chatBubbles.length - 1; i >= 0; i--) {
    const bubble = chatBubbles[i];

    bubble.y -= bubble.dy;        
    bubble.alpha -= 0.003;         

    if (bubble.alpha <= 0) {
      chatBubbles.splice(i, 1);   
      continue;
    }

    hostCtx.globalAlpha = bubble.alpha;
    hostCtx.fillStyle = "#000"; // ì™„ì „í•œ ê²€ì •
    hostCtx.font = "8px Arial";
    hostCtx.fillText(bubble.text, bubble.x, bubble.y);
    hostCtx.globalAlpha = 1.0;
    }

      requestAnimationFrame(drawHostCanvas); 
      }

      /////////////////////////////////////////////////////////////////////// ê°œë°œì¤‘ start , stop  ë¼ì´ë¸Œ 
      startRecordingBtn.addEventListener("click", () => {
        startRecordingBtn.style.display = "none";
        stopRecordingBtn.style.display = "inline";
        recordedChunks = [];

      initializeRole("host");

      const videoStream = hostCanvas.captureStream(30);
      let combinedStream = new MediaStream(videoStream.getVideoTracks());

      if (videoElement && !videoElement.paused) {
        const musicStream = videoElement.captureStream();
        const audioTracks = musicStream.getAudioTracks();
        audioTracks.forEach((track) => combinedStream.addTrack(track));
      }
      alert('ì„±ê³µ')

      mediaRecorder = new MediaRecorder(combinedStream, {
        mimeType: "video/webm; codecs=vp9",
      });

      mediaRecorder.ondataavailable = async (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
          
          const arrayBuffer = await event.data.arrayBuffer();
          socket.emit("videoChunk", arrayBuffer);
        }
      };

      mediaRecorder.start(1000); // 1ì´ˆë§ˆë‹¤ ì²­í¬ ì „ì†¡
      startRecordingBtn.style.display = "none";
      stopRecordingBtn.style.display = "inline";
    });

    stopRecordingBtn.addEventListener("click", () => {
      socket.emit("endRecording");
      startRecordingBtn.style.display = "inline";
      stopRecordingBtn.style.display = "none";
      mediaRecorder.stop();
        alert('ì¤‘ì§€')
    });


    /////////////////////////////////////////////////////////////
    
    playButton.addEventListener('click', () => {
      if (isPlaying) {
        videoElement.pause();
        playButton.innerHTML = 'â–¶';
      } else {
        videoElement.play();
        playButton.innerHTML = 'â¸';
      }
      isPlaying = !isPlaying;
    });

    volumeSlider.addEventListener('input', function () {
      videoElement.volume = this.value / 100;
    });

    // ì±„íŒ…
    const chatInput = document.querySelector('.chat-input input');
    const chatButton = document.querySelector('.chat-input button');
    const chatBox = document.getElementById('chat-box');

    function sendMessage() {
      const message = chatInput.value.trim();
      if (message !== '') {
        socket.emit('sendMessage', message); // ì„œë²„ë¡œë§Œ ë³´ëƒ„
        chatInput.value = '';
      }
    }

    chatButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    socket.on('receiveMessage', function (message) {
      // const { nickname, message } = data;
      const x = Math.floor(Math.random() * (hostCanvas.width - 100)) + 50;
      const y = hostCanvas.height - 30;
      const dy = 0.5;   // ì²œì²œíˆ ìœ„ë¡œ ì´ë™
      const alpha = 1;  // ì™„ì „ ë¶ˆíˆ¬ëª…í•˜ê²Œ ì‹œì‘
      // ë§í’ì„  ë°°ì—´ì— ì €ì¥
      chatBubbles.push({
        text: message,
        x: x,
        y: y,
        dy: dy,
        alpha: alpha,
        timestamp: Date.now()
      });


      // ì˜¤ë˜ëœ ë©”ì‹œì§€ëŠ” ì œê±° (ìµœëŒ€ 5ê°œ ìœ ì§€)
      if (chatBubbles.length > 5) chatBubbles.shift();
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      messageElement.innerHTML = `
      <div class="user-name">ë‚˜</div>
      <div class="message-text">${message}</div>
      `;
      console.log('ë°›ì€ ë©”ì‹œì§€:', message);
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;

      if (chatBubbles.length > 10) chatBubbles.shift();
    });

    socket.on('updateUserList', (userList) => {
  const userListDiv = document.querySelector('.user-list');
  userListDiv.innerHTML = '';
  userList.forEach(user => {
    const userItem = document.createElement('div');
    userItem.textContent = `ğŸ‘¤ ${user}`;
    userItem.className = 'user-item';
    userListDiv.appendChild(userItem);
  });
});
  </script>
</body>
</html>